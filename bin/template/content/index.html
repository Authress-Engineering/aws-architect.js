<!DOCTYPE html>

<html lang="en" ng-app="Index" ng-controller="mainController">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<base href="" />
	<title>Service Wrapper</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<script src="https://fgnass.github.io/spin.js/spin.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-touch.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-sanitize.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.5.1/js/bootstrap-datepicker.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.4.0/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.18/angular-ui-router.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.13.4/ui-bootstrap-tpls.min.js"></script>

	<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.7.1/loading-bar.min.css' type='text/css' media='all' />
	<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.7.1/loading-bar.min.js'></script>

	<script src="https://apis.google.com/js/client:plusone.js" type="text/javascript"></script>

	<script src="https://apis.google.com/js/client.js" async defer></script>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<script src="https://apis.google.com/js/auth.js"></script>

	<!--script src="https://connect.facebook.net/en_US/sdk.js"></script-->

	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.3.3.min.js"></script>

	<script>
		var AWS_REGION = 'us-east-1';
		AWS.config.region = AWS_REGION;

		var IDENTITY_POOL_ID = 'IDENTITY_POOL_ID';
		var GOOGLE_CLIENT_ID = 'GOOGLE_CLIENT_ID';
		var GOOGLE_CLIENT_SCOPES = 'openid email profile';
		function startApp() {
			gapi.load('auth', () => {
				setCookie('GoogleAuthState', 'auto', 100);
				gapi.auth.authorize({client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_CLIENT_SCOPES, response_type: 'token id_token', immediate: true}, (authResult) => {
					var authorizeButton = document.getElementById('google-signin-button');
					if (authResult && !authResult.error) {
						console.log(`Logged in successfully: authResult - ${JSON.stringify(authResult)}`);
						authorizeButton.style.visibility = 'hidden';
						angular.element($('*')).scope().page.cognitoLogin(authResult.id_token);
					} else {
						console.log(`Not logged in: ${JSON.stringify(authResult)}`);
						authorizeButton.style.visibility = '';
					}
				});
			});
		}


		function gup(parameterName) {
			var name = parameterName.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
			var regexS = "[\\?&#]" + name + "=([^&#]*)";
			var regex = new RegExp(regexS);
			var results = regex.exec(window.location.href);
			return results ? results[1] : null;
		}

		var module = angular.module('Index', ['ngSanitize', 'angular-loading-bar', 'ngAnimate']);
		module.controller('mainController', function($scope, $http, $timeout) {
			$scope.page = {
				cognitoLogin: (idToken) => {
					console.log('Starting Cognito Login.');
					//if there is an error, then the url header will look like: url/#error_subtype=access_denied&error=interaction_required
					console.log(`ID TOKEN: ${idToken}`);
					var nonce = getCookie('GoogleAuthState');
					if(nonce != gup('nonce') && nonce != 'auto') {
						console.error(`Nonce does not match what was sent to Google, authentication rejected.`);
						return;
					}
					var params = {
						IdentityPoolId: IDENTITY_POOL_ID,
						Logins: {
							'accounts.google.com': idToken
						}
					};

					//TODO: Get profile information: https://www.googleapis.com/plus/v1/people/me/openIdConnect

					AWS.config.credentials = new AWS.CognitoIdentityCredentials(params);
				},
				sync: () => {
					AWS.config.credentials.get(function(err) {
						if (err) {
							console.log(`Could not authenticate against Idendtity Pool or Trust for IAM Role using credentials: ${err}`);
							return;
						}
						console.log("Cognito Identity Id: " + AWS.config.credentials.identityId);

						//SYNC Manager: https://github.com/aws/amazon-cognito-js
						/*
						var cognitoSyncClient = new AWS.CognitoSync();
						cognitoSyncClient.listDatasets({
							IdentityId: AWS.config.credentials.identityId,
							IdentityPoolId: params.IdentityPoolId
						}, function(err, data) {
							if(err) {
								console.error("Error!" + err);
							}
							else {
								console.log(JSON.stringify(data));
							}
						});

						// Create a record in a dataset and synchronize with the server
							Dataset dataset = syncClient.openOrCreateDataset("myDataset");
							dataset.put("myKey", "myValue");
							dataset.synchronize(new DefaultSyncCallback() {
								@Override
								public void onSuccess(Dataset dataset, List newRecords) {
									//Your handler code here
								}
							});
						*/
					});
				},
				googleLogin: function() {
					var createGuid = () => {
						return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
							var r = Math.random()*16|0
							var v = c === 'x' ? r : (r&0x3|0x8);
							return v.toString(16);
						});
					}

					var guid = createGuid();
					setCookie('GoogleAuthState', guid, 1);
					var paramString = $.param({
						response_type:'id_token',
						scope: GOOGLE_CLIENT_SCOPES,
						client_id: GOOGLE_CLIENT_ID,
						nonce: guid,
						redirect_uri: window.location.href
					});
					window.open(`https://accounts.google.com/o/oauth2/v2/auth?${paramString}`, null, null, true);
				}
			};
		});

/*  FACEBOOK LOGIN
		function facebook() {
			FB.init({
				appId: '1074284359298079',
				xfbml: true,
				version: 'v2.6'
			});

			FB.getLoginStatus(function(response) {
				if (response.status === 'connected') {
					console.log('Logged in.');
					console.log(response.authResponse.accessToken);

					var params = {
						IdentityPoolId: IDENTITY_POOL_ID,
						Logins: {
							'graph.facebook.com': response.authResponse.accessToken
						}
					};

					AWS.config.region = 'us-east-1';
					AWS.config.credentials = new AWS.CognitoIdentityCredentials(params);
					AWS.config.credentials.get(function(err) {
						if (err) {
							console.log(`Could not authenticate against Idendtity Pool or Trust for IAM Role using credentials: ${err}`);
							return;
						}
						console.log("Cognito Identity Id: " + AWS.config.credentials.identityId);
					});
				}
				else {
					console.log('Need to log in.')
					FB.login();
				}
			});
		};
*/

		function setCookie(cname, cvalue, exdays) {
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+d.toUTCString();
			document.cookie = cname + "=" + cvalue + "; " + expires;
		}

		function getCookie(cname) {
			var name = cname + "=";
			var ca = document.cookie.split(';');
			for(var i=0; i<ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1);
				if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
			}
			return "";
		}

		function deleteCookie(cname) {
			document.cookie = cname + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
		}
	</script>

<body>

	<a id="google-signin-button" style="visibility:hidden;" ng-href='#' ng-click='page.googleLogin()'><img src="btn_google_signin_dark_normal_web.png"></a> <br />
	<script>startApp();</script>
</body>

</html>